import{r as S,g as q,j as le,aA as ue,ap as oe,aM as de,h as p,ab as ce,ac as pe,ba as ve,$ as fe,bb as _e,w as me,E as ge,k as be,bc as he,bd as Fe,aE as V,O as ye,S as ee,V as qe,be as Se}from"./index.fbd59a76.js";import{Q as ze}from"./QCircularProgress.03fa6c11.js";import{h as ae}from"./format.c926bd4b.js";function M(r,v,a,m){const n=[];return r.forEach(g=>{m(g)===!0?n.push(g):v.push({failedPropValidation:a,file:g})}),n}function W(r){r&&r.dataTransfer&&(r.dataTransfer.dropEffect="copy"),oe(r)}const Ue={multiple:Boolean,accept:String,capture:String,maxFileSize:[Number,String],maxTotalSize:[Number,String],maxFiles:[Number,String],filter:Function},xe=["rejected"];function we({editable:r,dnd:v,getFileInput:a,addFilesToQueue:m}){const{props:n,emit:g,proxy:w}=le(),P=S(null),N=q(()=>n.accept!==void 0?n.accept.split(",").map(l=>(l=l.trim(),l==="*"?"*/":(l.endsWith("/*")&&(l=l.slice(0,l.length-1)),l.toUpperCase()))):null),U=q(()=>parseInt(n.maxFiles,10)),O=q(()=>parseInt(n.maxTotalSize,10));function T(l){if(r.value)if(l!==Object(l)&&(l={target:null}),l.target!==null&&l.target.matches('input[type="file"]')===!0)l.clientX===0&&l.clientY===0&&ue(l);else{const F=a();F&&F!==l.target&&F.click(l)}}function R(l){r.value&&l&&m(null,l)}function t(l,F,C,j){let o=Array.from(F||l.target.files);const b=[],z=()=>{b.length>0&&g("rejected",b)};if(n.accept!==void 0&&N.value.indexOf("*/")===-1&&(o=M(o,b,"accept",d=>N.value.some(f=>d.type.toUpperCase().startsWith(f)||d.name.toUpperCase().endsWith(f))),o.length===0))return z();if(n.maxFileSize!==void 0){const d=parseInt(n.maxFileSize,10);if(o=M(o,b,"max-file-size",f=>f.size<=d),o.length===0)return z()}if(n.multiple!==!0&&o.length>0&&(o=[o[0]]),o.forEach(d=>{d.__key=d.webkitRelativePath+d.lastModified+d.name+d.size}),j===!0){const d=C.map(f=>f.__key);o=M(o,b,"duplicate",f=>d.includes(f.__key)===!1)}if(o.length===0)return z();if(n.maxTotalSize!==void 0){let d=j===!0?C.reduce((f,L)=>f+L.size,0):0;if(o=M(o,b,"max-total-size",f=>(d+=f.size,d<=O.value)),o.length===0)return z()}if(typeof n.filter=="function"){const d=n.filter(o);o=M(o,b,"filter",f=>d.includes(f))}if(n.maxFiles!==void 0){let d=j===!0?C.length:0;if(o=M(o,b,"max-files",()=>(d++,d<=U.value)),o.length===0)return z()}if(z(),o.length>0)return o}function u(l){W(l),v.value!==!0&&(v.value=!0)}function _(l){oe(l),(l.relatedTarget!==null||de.is.safari!==!0?l.relatedTarget!==P.value:document.elementsFromPoint(l.clientX,l.clientY).includes(P.value)===!1)===!0&&(v.value=!1)}function x(l){W(l);const F=l.dataTransfer.files;F.length>0&&m(null,F),v.value=!1}function c(l){if(v.value===!0)return p("div",{ref:P,class:`q-${l}__dnd absolute-full`,onDragenter:W,onDragover:W,onDragleave:_,onDrop:x})}return Object.assign(w,{pickFiles:T,addFiles:R}),{pickFiles:T,addFiles:R,onDragover:u,onDragleave:_,processFiles:t,getDndNode:c,maxFilesNumber:U,maxTotalSizeNumber:O}}function te(r){return(r*100).toFixed(2)+"%"}const ke={...ce,...Ue,label:String,color:String,textColor:String,square:Boolean,flat:Boolean,bordered:Boolean,noThumbnails:Boolean,autoUpload:Boolean,hideUploadBtn:Boolean,disable:Boolean,readonly:Boolean},re=[...xe,"start","finish","added","removed"];function Ee(r){const v=le(),{props:a,slots:m,emit:n,proxy:g}=v,{$q:w}=g,P=pe(a,w);function N(e,s,h){if(e.__status=s,s==="idle"){e.__uploaded=0,e.__progress=0,e.__sizeLabel=ae(e.size),e.__progressLabel="0.00%";return}if(s==="failed"){g.$forceUpdate();return}e.__uploaded=s==="uploaded"?e.size:h,e.__progress=s==="uploaded"?1:Math.min(.9999,e.__uploaded/e.size),e.__progressLabel=te(e.__progress),g.$forceUpdate()}const U=q(()=>a.disable!==!0&&a.readonly!==!0),O=S(!1),T=S(null),R=S(null),t={files:S([]),queuedFiles:S([]),uploadedFiles:S([]),uploadedSize:S(0),updateFileStatus:N,isAlive:()=>ve(v)===!1},{pickFiles:u,addFiles:_,onDragover:x,onDragleave:c,processFiles:l,getDndNode:F,maxFilesNumber:C,maxTotalSizeNumber:j}=we({editable:U,dnd:O,getFileInput:G,addFilesToQueue:K});Object.assign(t,r({props:a,slots:m,emit:n,helpers:t})),t.isBusy===void 0&&(t.isBusy=S(!1));const o=S(0),b=q(()=>o.value===0?0:t.uploadedSize.value/o.value),z=q(()=>te(b.value)),d=q(()=>ae(o.value)),f=q(()=>U.value===!0&&t.isUploading.value!==!0&&(a.multiple===!0||t.queuedFiles.value.length===0)&&(a.maxFiles===void 0||t.files.value.length<C.value)&&(a.maxTotalSize===void 0||o.value<j.value)),L=q(()=>U.value===!0&&t.isBusy.value!==!0&&t.isUploading.value!==!0&&t.queuedFiles.value.length>0);fe(_e,J);const i=q(()=>"q-uploader column no-wrap"+(P.value===!0?" q-uploader--dark q-dark":"")+(a.bordered===!0?" q-uploader--bordered":"")+(a.square===!0?" q-uploader--square no-border-radius":"")+(a.flat===!0?" q-uploader--flat no-shadow":"")+(a.disable===!0?" disabled q-uploader--disable":"")+(O.value===!0?" q-uploader--dnd":"")),D=q(()=>"q-uploader__header"+(a.color!==void 0?` bg-${a.color}`:"")+(a.textColor!==void 0?` text-${a.textColor}`:""));me(t.isUploading,(e,s)=>{s===!1&&e===!0?n("start"):s===!0&&e===!1&&n("finish")});function A(){a.disable===!1&&(t.abort(),t.uploadedSize.value=0,o.value=0,Y(),t.files.value=[],t.queuedFiles.value=[],t.uploadedFiles.value=[])}function Q(){a.disable===!1&&H(["uploaded"],()=>{t.uploadedFiles.value=[]})}function k(){H(["idle","failed"],({size:e})=>{o.value-=e,t.queuedFiles.value=[]})}function H(e,s){if(a.disable===!0)return;const h={files:[],size:0},E=t.files.value.filter(y=>e.indexOf(y.__status)===-1?!0:(h.size+=y.size,h.files.push(y),y.__img!==void 0&&window.URL.revokeObjectURL(y.__img.src),!1));h.files.length>0&&(t.files.value=E,s(h),n("removed",h.files))}function X(e){a.disable||(e.__status==="uploaded"?t.uploadedFiles.value=t.uploadedFiles.value.filter(s=>s.__key!==e.__key):e.__status==="uploading"?e.__abort():o.value-=e.size,t.files.value=t.files.value.filter(s=>s.__key!==e.__key?!0:(s.__img!==void 0&&window.URL.revokeObjectURL(s.__img.src),!1)),t.queuedFiles.value=t.queuedFiles.value.filter(s=>s.__key!==e.__key),n("removed",[e]))}function Y(){t.files.value.forEach(e=>{e.__img!==void 0&&window.URL.revokeObjectURL(e.__img.src)})}function G(){return R.value||T.value.getElementsByClassName("q-uploader__input")[0]}function K(e,s){const h=l(e,s,t.files.value,!0),E=G();E!=null&&(E.value=""),h!==void 0&&(h.forEach(y=>{if(t.updateFileStatus(y,"idle"),o.value+=y.size,a.noThumbnails!==!0&&y.type.toUpperCase().startsWith("IMAGE")){const Z=new Image;Z.src=window.URL.createObjectURL(y),y.__img=Z}}),t.files.value=t.files.value.concat(h),t.queuedFiles.value=t.queuedFiles.value.concat(h),n("added",h),a.autoUpload===!0&&t.upload())}function ne(){L.value===!0&&t.upload()}function $(e,s,h){if(e===!0){const E={type:"a",key:s,icon:w.iconSet.uploader[s],flat:!0,dense:!0};let y;return s==="add"?(E.onClick=u,y=J):E.onClick=h,p(ee,E,y)}}function J(){return p("input",{ref:R,class:"q-uploader__input overflow-hidden absolute-full",tabindex:-1,type:"file",title:"",accept:a.accept,multiple:a.multiple===!0?"multiple":void 0,capture:a.capture,onMousedown:ue,onClick:u,onChange:K})}function ie(){return m.header!==void 0?m.header(I):[p("div",{class:"q-uploader__header-content column"},[p("div",{class:"flex flex-center no-wrap q-gutter-xs"},[$(t.queuedFiles.value.length>0,"removeQueue",k),$(t.uploadedFiles.value.length>0,"removeUploaded",Q),t.isUploading.value===!0?p(V,{class:"q-uploader__spinner"}):null,p("div",{class:"col column justify-center"},[a.label!==void 0?p("div",{class:"q-uploader__title"},[a.label]):null,p("div",{class:"q-uploader__subtitle"},[d.value+" / "+z.value])]),$(f.value,"add"),$(a.hideUploadBtn===!1&&L.value===!0,"upload",t.upload),$(t.isUploading.value,"clear",t.abort)])])]}function se(){return m.list!==void 0?m.list(I):t.files.value.map(e=>p("div",{key:e.__key,class:"q-uploader__file relative-position"+(a.noThumbnails!==!0&&e.__img!==void 0?" q-uploader__file--img":"")+(e.__status==="failed"?" q-uploader__file--failed":e.__status==="uploaded"?" q-uploader__file--uploaded":""),style:a.noThumbnails!==!0&&e.__img!==void 0?{backgroundImage:'url("'+e.__img.src+'")'}:null},[p("div",{class:"q-uploader__file-header row flex-center no-wrap"},[e.__status==="failed"?p(ye,{class:"q-uploader__file-status",name:w.iconSet.type.negative,color:"negative"}):null,p("div",{class:"q-uploader__file-header-content col"},[p("div",{class:"q-uploader__title"},[e.name]),p("div",{class:"q-uploader__subtitle row items-center no-wrap"},[e.__sizeLabel+" / "+e.__progressLabel])]),e.__status==="uploading"?p(ze,{value:e.__progress,min:0,max:1,indeterminate:e.__progress===0}):p(ee,{round:!0,dense:!0,flat:!0,icon:w.iconSet.uploader[e.__status==="uploaded"?"done":"clear"],onClick:()=>{X(e)}})])]))}ge(()=>{t.isUploading.value===!0&&t.abort(),t.files.value.length>0&&Y()});const I={};for(const e in t)be(t[e])===!0?he(I,e,()=>t[e].value):I[e]=t[e];return Object.assign(I,{upload:ne,reset:A,removeUploadedFiles:Q,removeQueuedFiles:k,removeFile:X,pickFiles:u,addFiles:_}),Fe(I,{canAddFiles:()=>f.value,canUpload:()=>L.value,uploadSizeLabel:()=>d.value,uploadProgressLabel:()=>z.value}),Object.assign(g,I),()=>{const e=[p("div",{class:D.value},ie()),p("div",{class:"q-uploader__list scroll"},se()),F("uploader")];t.isBusy.value===!0&&e.push(p("div",{class:"q-uploader__overlay absolute-full flex flex-center"},[p(V)]));const s={ref:T,class:i.value};return f.value===!0&&Object.assign(s,{onDragover:x,onDragleave:c}),p("div",s,e)}}const Be=()=>!0;function Re(r){const v={};return r.forEach(a=>{v[a]=Be}),v}const Ce=Re(re);var je=({name:r,props:v,emits:a,injectPlugin:m})=>qe({name:r,props:{...ke,...v},emits:Se(a)===!0?{...Ce,...a}:[...re,...a],setup(){return Ee(m)}});function B(r){return typeof r=="function"?r:()=>r}const Le={url:[Function,String],method:{type:[Function,String],default:"POST"},fieldName:{type:[Function,String],default:()=>r=>r.name},headers:[Function,Array],formFields:[Function,Array],withCredentials:[Function,Boolean],sendRaw:[Function,Boolean],batch:[Function,Boolean],factory:Function},Pe=["factoryFailed","uploaded","failed","uploading"];function Oe({props:r,emit:v,helpers:a}){const m=S([]),n=S([]),g=S(0),w=q(()=>({url:B(r.url),method:B(r.method),headers:B(r.headers),formFields:B(r.formFields),fieldName:B(r.fieldName),withCredentials:B(r.withCredentials),sendRaw:B(r.sendRaw),batch:B(r.batch)})),P=q(()=>g.value>0),N=q(()=>n.value.length>0);let U;function O(){m.value.forEach(u=>{u.abort()}),n.value.length>0&&(U=!0)}function T(){const u=a.queuedFiles.value.slice(0);a.queuedFiles.value=[],w.value.batch(u)?R(u):u.forEach(_=>{R([_])})}function R(u){if(g.value++,typeof r.factory!="function"){t(u,{});return}const _=r.factory(u);if(!_)v("factoryFailed",new Error("QUploader: factory() does not return properly"),u),g.value--;else if(typeof _.catch=="function"&&typeof _.then=="function"){n.value.push(_);const x=c=>{a.isAlive()===!0&&(n.value=n.value.filter(l=>l!==_),n.value.length===0&&(U=!1),a.queuedFiles.value=a.queuedFiles.value.concat(u),u.forEach(l=>{a.updateFileStatus(l,"failed")}),v("factoryFailed",c,u),g.value--)};_.then(c=>{U===!0?x(new Error("Aborted")):a.isAlive()===!0&&(n.value=n.value.filter(l=>l!==_),t(u,c))}).catch(x)}else t(u,_||{})}function t(u,_){const x=new FormData,c=new XMLHttpRequest,l=(i,D)=>_[i]!==void 0?B(_[i])(D):w.value[i](D),F=l("url",u);if(!F){console.error("q-uploader: invalid or no URL specified"),g.value--;return}const C=l("formFields",u);C!==void 0&&C.forEach(i=>{x.append(i.name,i.value)});let j=0,o=0,b=0,z=0,d;c.upload.addEventListener("progress",i=>{if(d===!0)return;const D=Math.min(z,i.loaded);a.uploadedSize.value+=D-b,b=D;let A=b-o;for(let Q=j;A>0&&Q<u.length;Q++){const k=u[Q];if(A>k.size)A-=k.size,j++,o+=k.size,a.updateFileStatus(k,"uploading",k.size);else{a.updateFileStatus(k,"uploading",A);return}}},!1),c.onreadystatechange=()=>{c.readyState<4||(c.status&&c.status<400?(a.uploadedFiles.value=a.uploadedFiles.value.concat(u),u.forEach(i=>{a.updateFileStatus(i,"uploaded")}),v("uploaded",{files:u,xhr:c})):(d=!0,a.uploadedSize.value-=b,a.queuedFiles.value=a.queuedFiles.value.concat(u),u.forEach(i=>{a.updateFileStatus(i,"failed")}),v("failed",{files:u,xhr:c})),g.value--,m.value=m.value.filter(i=>i!==c))},c.open(l("method",u),F),l("withCredentials",u)===!0&&(c.withCredentials=!0);const f=l("headers",u);f!==void 0&&f.forEach(i=>{c.setRequestHeader(i.name,i.value)});const L=l("sendRaw",u);u.forEach(i=>{a.updateFileStatus(i,"uploading",0),L!==!0&&x.append(l("fieldName",i),i,i.name),i.xhr=c,i.__abort=()=>{c.abort()},z+=i.size}),v("uploading",{files:u,xhr:c}),m.value.push(c),L===!0?c.send(new Blob(u)):c.send(x)}return{isUploading:P,isBusy:N,abort:O,upload:T}}var Te={name:"QUploader",props:Le,emits:Pe,injectPlugin:Oe},Ae=je(Te);export{Ae as Q};
